<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ابزار تبدیل اشتراک</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shabnam:wght@400;700&family=IRANSans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a0a0ff' width='32px' height='32px'%3E%3Cpath d='M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z'/%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        :root { /* پوسته تیره به عنوان پیش‌فرض */
            --bg-color: #0a0a0a;
            --body-bg-image-url: url('https://images.unsplash.com/photo-1538370965046-9667c40b66c0?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'); /* پس‌زمینه مدرن و تیره */
            --body-bg-filter: grayscale(0.2) brightness(0.8) contrast(1.1); /* فیلتر شیک */
            --container-bg-image-url: url('https://images.unsplash.com/photo-1516321310766-61b7c93e3e57?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'); /* پس‌زمینه ابزار */
            --container-overlay-color-start: rgba(20, 20, 20, 0.85);
            --container-overlay-color-end: rgba(15, 15, 15, 0.95);
            --card-bg-color-rgb: 28, 28, 28;
            --text-color: #e6e6e6;
            --label-color: #b3b3b3;
            --input-bg-color: #2a2a2a;
            --input-border-color: #555;
            --button-bg-color: #1e88e5;
            --button-text-color: #ffffff;
            --button-hover-bg: #1565c0;
            --primary-color: #64b5f6;
            --output-field-bg: #111;
            --footer-link-bg: #333;
            --footer-link-hover-bg: #4f4f4f;
            --theme-toggle-bg: var(--input-bg-color);
            --theme-toggle-text: var(--text-color);
            --theme-toggle-border: var(--input-border-color);
            --message-box-bg-success: #2e7d32;
            --message-box-bg-error: #d32f2f;
            --message-box-bg-info: #0288d1;
            --message-box-text: #fff;
        }

        body.light-theme {
            --bg-color: #e3f2fd;
            --body-bg-image-url: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'); /* پس‌زمینه روشن و جذاب */
            --body-bg-filter: brightness(1.05) contrast(1.0); /* فیلتر ملایم */
            --container-bg-image-url: url('https://images.unsplash.com/photo-1557683316-973673baf926?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');
            --container-overlay-color-start: rgba(255, 255, 255, 0.80);
            --container-overlay-color-end: rgba(245, 245, 245, 0.90);
            --card-bg-color-rgb: 250, 250, 250;
            --text-color: #1a237e;
            --label-color: #455a64;
            --input-bg-color: #ffffff;
            --input-border-color: #90caf9;
            --button-bg-color: #1976d2;
            --button-text-color: #ffffff;
            --button-hover-bg: #115293;
            --primary-color: #3f51b5;
            --output-field-bg: #e3f2fd;
            --footer-link-bg: #e0e0e0;
            --footer-link-hover-bg: #cfcfcf;
            --theme-toggle-bg: #fff;
            --theme-toggle-text: #333;
            --theme-toggle-border: #90caf9;
            --message-box-bg-success: #2e7d32;
            --message-box-bg-error: #d32f2f;
            --message-box-bg-info: #0288d1;
            --message-box-text: #fff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'IRANSans', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.6;
            box-sizing: border-box;
            position: relative;
            z-index: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--body-bg-image-url);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            filter: var(--body-bg-filter);
            z-index: -1;
            transition: filter 0.3s ease;
        }

        .container {
            background-image:
                linear-gradient(var(--container-overlay-color-start), var(--container-overlay-color-end)),
                var(--container-bg-image-url);
            background-color: rgba(var(--card-bg-color-rgb), 0.97);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            padding: 30px;
            border-radius: 16px;
            border: 1px solid var(--input-border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 800px;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
            margin-top: 20px;
            margin-bottom: 20px;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        h1 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 35px;
            font-family: 'Shabnam', sans-serif;
            font-weight: 700;
            font-size: 2.2em;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--label-color);
            font-weight: 700;
            font-size: 1.1em;
        }

        .form-group input[type="text"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border-radius: 8px;
            font-family: 'IRANSans', sans-serif;
            box-sizing: border-box;
            font-size: 1em;
            direction: ltr;
            text-align: left;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .form-group textarea {
            direction: rtl;
            text-align: right;
            min-height: 120px; /* افزایش اندازه برای وضوح بیشتر */
            resize: vertical;
            font-size: 1.05em;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #888;
            text-align: right;
            direction: rtl;
        }

        .form-group input[type="text"],
        .form-group select {
            direction: ltr;
            text-align: left;
        }

        .form-group select option {
            font-family: 'IRANSans', sans-serif;
            background-color: var(--input-bg-color);
            color: var(--text-color);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 10px;
            text-align: right;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            background-color: var(--input-bg-color);
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            justify-content: flex-end;
            font-size: 0.9em;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .checkbox-group label:hover {
            background-color: var(--button-hover-bg);
            color: var(--button-text-color);
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 0;
            margin-right: 8px;
            transform: scale(1.1);
        }

        .button-group {
            text-align: center;
            margin-top: 30px;
        }

        button {
            background-color: var(--button-bg-color);
            color: var(--button-text-color);
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-family: 'IRANSans', sans-serif;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin: 5px;
        }

        button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }

        button.copy-btn,
        button.download-btn {
            background-color: #2e7d32;
        }

        button.copy-btn:hover,
        button.download-btn:hover {
            background-color: #1b5e20;
        }

        button.download-btn {
            background-color: #0288d1;
        }

        button.download-btn:hover {
            background-color: #01579b;
        }

        .output-group {
            margin-top: 30px;
        }

        .output-group input {
            direction: ltr;
            text-align: left;
            background-color: var(--output-field-bg);
            border-color: var(--primary-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .footer {
            margin-top: 50px;
            padding-top: 25px;
            border-top: 1px solid var(--input-border-color);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            transition: border-color 0.3s ease;
        }

        .footer a {
            display: inline-flex;
            align-items: center;
            color: var(--label-color);
            text-decoration: none;
            font-size: 0.9em;
            transition: color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            padding: 8px 15px;
            background-color: var(--footer-link-bg);
            border-radius: 25px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .footer a:hover {
            color: var(--text-color);
            background-color: var(--footer-link-hover-bg);
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .footer img {
            width: 18px;
            height: 18px;
            margin-left: 10px;
            vertical-align: middle;
            border-radius: 4px;
        }

        #theme-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            padding: 8px 12px;
            background: var(--theme-toggle-bg);
            color: var(--theme-toggle-text);
            border: 1px solid var(--theme-toggle-border);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        #theme-toggle:hover {
            background: var(--button-hover-bg);
            color: var(--button-text-color);
        }

        #message-box {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            padding: 15px 20px;
            border-radius: 0 0 8px 8px;
            text-align: center;
            color: var(--message-box-text);
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out, top 0.4s ease-in-out;
            direction: rtl;
        }

        #message-box.show {
            opacity: 1;
            visibility: visible;
            top: 20px;
        }

        #message-box.success {
            background-color: var(--message-box-bg-success);
        }

        #message-box.error {
            background-color: var(--message-box-bg-error);
        }

        #message-box.info {
            background-color: var(--message-box-bg-info);
        }

        @media (max-width: 600px) {
            body {
                align-items: flex-start;
            }

            .container {
                margin-top: 60px;
                margin-bottom: 10px;
                padding: 20px 15px;
            }

            .checkbox-group {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 8px;
            }

            .checkbox-group label {
                font-size: 0.85em;
                padding: 6px 10px;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 25px;
            }

            #theme-toggle {
                top: 10px;
                left: 10px;
                padding: 6px 10px;
                font-size: 0.8em;
            }

            #message-box {
                width: 95%;
                padding: 10px 15px;
                font-size: 0.9em;
            }

            .form-group textarea {
                min-height: 100px;
            }
        }

        .input-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-toggle-container select,
        .input-toggle-container input[type="text"] {
            flex-grow: 1;
        }

        .input-toggle-container .custom-toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            white-space: nowrap;
            background-color: var(--input-bg-color);
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--input-border-color);
            color: var(--text-color);
            transition: background-color 0.2s, border-color 0.2s;
        }

        .input-toggle-container .custom-toggle-label:hover {
            background-color: var(--button-hover-bg);
            color: var(--button-text-color);
        }

        .input-toggle-container .custom-toggle-label input[type="checkbox"] {
            margin-left: 0;
            margin-right: 8px;
        }

        .hidden {
            display: none !important;
        }

        #advanced-features-section {
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            background-color: rgba(var(--card-bg-color-rgb), 0.7);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        #advanced-features-section.hidden-section {
            display: none;
        }

        #toggle-advanced-btn {
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--input-border-color);
            padding: 10px 20px;
            border-radius: 5px;
            font-family: 'IRANSans', sans-serif;
            font-size: 1em;
            cursor: pointer;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        #toggle-advanced-btn:hover {
            background-color: var(--button-hover-bg);
            color: var(--button-text-color);
        }
    </style>
</head>
<body>
    <button id="theme-toggle">تغییر تم 🌞/🌜</button>

    <div id="message-box"></div>

    <div class="container">
        <h1>ابزار تبدیل اشتراک</h1>

        <div class="form-group">
            <label for="sub-url">لینک های اشتراک:</label>
            <textarea id="sub-url" rows="6"
                      placeholder="لینک های اشتراک خود را وارد کنید.
برای چند لینک، هر کدام را در یک خط جدید یا با | جدا کنید.
اگر از لینک اشتراک معمولی استفاده می‌کنید، تیک «تبدیل به بیس ۶۴» را فعال کنید."></textarea>
        </div>

        <div class="form-group">
            <label for="target">نوع خروجی:</label>
            <select id="target">
                <option value="clash" selected>کلش (Clash)</option>
                <option value="surge&ver=4">سورج ۴/۵ (Surge 4/5)</option>
                <option value="singbox">سینگ‌باکس (Sing-Box)</option>
                <option value="v2ray">وی‌تو‌ری (V2Ray)</option>
                <option value="trojan">تروجان (Trojan)</option>
                <option value="ssr">شدوساکس آر (SSR)</option>
                <option value="mixed">ترکیبی (Mixed)</option>
                <option value="surfboard">سرف‌بورد (Surfboard)</option>
                <option value="quan">کوانتومولت (Quantumult)</option>
                <option value="quanx">کوانتومولت ایکس (Quantumult X)</option>
                <option value="loon">لون (Loon)</option>
                <option value="mellow">ملو (Mellow)</option>
                <option value="surge&ver=3">سورج ۳ (Surge 3)</option>
                <option value="surge&ver=2">سورج ۲ (Surge 2)</option>
                <option value="clashr">کلش آر (ClashR)</option>
                <option value="ss">شدوساکس (SIP002)</option>
                <option value="ssand">شدوساکس اندروید (SIP008)</option>
                <option value="ssd">شدوساکس دی (SSD)</option>
            </select>
        </div>

        <div class="form-group">
            <label>آدرس سرویس مبدل (API):</label>
            <div class="input-toggle-container">
                <select id="api-url-select" class="dynamic-input">
                    </select>
                <input type="text" id="api-url-custom" class="dynamic-input hidden" placeholder="آدرس API دلخواه خود را وارد کنید">
                <label class="custom-toggle-label">
                    <input type="checkbox" id="api-url-custom-toggle"> دلخواه
                </label>
            </div>
        </div>

        <div class="form-group">
            <label>پیکربندی ریموت:</label>
            <div class="input-toggle-container">
                <select id="config-select" class="dynamic-input">
                    </select>
                <input type="text" id="config-custom" class="dynamic-input hidden" placeholder="آدرس پیکربندی دلخواه خود را وارد کنید">
                <label class="custom-toggle-label">
                    <input type="checkbox" id="config-custom-toggle"> دلخواه
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="output-filename">نام فایل خروجی:</label>
            <input type="text" id="output-filename" placeholder="نام فایل خروجی (اختیاری)">
        </div>

        <div class="form-group">
            <label>گزینه‌ها:</label>
            <div class="checkbox-group">
                <label> نمایش اموجی پرچم<input type="checkbox" id="emoji" checked></label>
                <label> فعال‌سازی UDP<input type="checkbox" id="udp" checked></label>
                <label> فعال‌سازی TFO<input type="checkbox" id="tfo"></label>
                <label> گسترش قوانین<input type="checkbox" id="expand"></label>
                <label> پرش از بررسی گواهی<input type="checkbox" id="scv"></label>
                <label> فیلتر دامنه‌های نامناسب<input type="checkbox" id="fdn" checked></label>
                <label> نام‌گذاری جدید Clash<input type="checkbox" id="new_name" checked></label>
                <label> افزودن نودهای پیش‌فرض<input type="checkbox" id="insert"></label>
                <label> فعال‌سازی XUDP<input type="checkbox" id="xudp"></label>
                <label> فعال‌سازی TLS 1.3<input type="checkbox" id="tls13"></label>
                <label> مرتب‌سازی نودها<input type="checkbox" id="sort"></label>
                <label> افزودن نوع نود<input type="checkbox" id="append_type"></label>
                <label> فیلتر نودهای ناسازگار<input type="checkbox" id="f_un"></label>
                <label title="در صورت فعال بودن، لینک اشتراک توسط سرور واسط دانلود، به Base64 تبدیل و سپس به API مبدل ارسال می‌شود. این گزینه ممکن است برای برخی لینک‌های خاص مفید باشد.">
                    تبدیل به بیس ۶۴
                    <input type="checkbox" id="use_custom_base64_worker">
                </label>
                <label>فقط خروجی اطلاعات نود<input type="checkbox" id="node-list-only"></label>
            </div>
        </div>

        <button id="toggle-advanced-btn">قابلیت‌های پیشرفته: (نمایش/پنهان کردن)</button>

        <div id="advanced-features-section" class="hidden-section">
            <div class="form-group">
                <label for="include-remarks">شامل نودها (regex):</label>
                <textarea id="include-remarks" rows="2" placeholder="توضیحات یا کلمات کلیدی برای شامل کردن نودها (پشتیبانی از Regex)"></textarea>
            </div>

            <div class="form-group">
                <label for="exclude-remarks">حذف نودها (regex):</label>
                <textarea id="exclude-remarks" rows="2" placeholder="توضیحات یا کلمات کلیدی برای حذف نودها (پشتیبانی از Regex)"></textarea>
            </div>

            <div class="form-group">
                <label for="node-rename">نام‌گذاری نود:</label>
                <input type="text" id="node-rename" placeholder="مثال: `a@b``1@2`، کاراکتر | قابل استفاده است با \escape">
            </div>

            <div class="form-group">
                <label for="remote-device-id">شناسه دستگاه ریموت:</label>
                <input type="text" id="remote-device-id" placeholder="برای تنظیم شناسه دستگاه ریموت QuantumultX استفاده می‌شود">
            </div>
        </div>

        <div class="button-group">
            <button id="generate-btn">تولید لینک اشتراک</button>
        </div>

        <div class="output-group form-group">
            <label for="output-url">لینک تولید شده:</label>
            <div style="display: flex; align-items: center;">
                <input type="text" id="output-url" readonly placeholder="لینک نهایی در اینجا نمایش داده می‌شود..." style="flex-grow: 1;">
                <button id="copy-btn" class="copy-btn" style="width: auto; padding: 10px 15px; margin-right: 10px; flex-shrink: 0;">کپی</button>
                <button id="download-btn" class="download-btn" style="width: auto; padding: 10px 15px; flex-shrink: 0;">دانلود فایل</button>
            </div>
        </div>

        <div class="footer">
            <a href="https://github.com/Argh94" target="_blank" rel="noopener noreferrer">
                <img src="https://www.google.com/s2/favicons?sz=32&domain=github.com" alt="GitHub">
                <span>گیت‌هاب</span>
            </a>
        </div>
    </div>

    <script>
        // --- Custom Message Box Function ---
        const messageBox = document.getElementById('message-box');
        let messageTimeout;

        function showMessage(message, type = 'info', duration = 3000) {
            if (!messageBox) {
                console.error("Message box element not found!");
                return;
            }
            clearTimeout(messageTimeout);
            messageBox.textContent = message;
            messageBox.className = '';
            messageBox.classList.add(type);
            messageBox.classList.add('show');
            messageTimeout = setTimeout(() => {
                messageBox.classList.remove('show');
                setTimeout(() => { messageBox.textContent = ''; }, 500);
            }, duration);
        }

        // --- Rate Limiting ---
        const MAX_CLICKS_CLIENT = 30;
        const TIME_WINDOW_CLIENT_MS = 60 * 60 * 1000;
        const TIMEOUT_DURATION_CLIENT_MS = 2 * 60 * 60 * 1000;

        function getRateLimitData() {
            const data = localStorage.getItem('clientRateLimit');
            if (data) {
                try { return JSON.parse(data); }
                catch (e) {
                    console.error("Error parsing rate limit data:", e);
                    localStorage.removeItem('clientRateLimit');
                    return { clicks: 0, windowStart: 0, blockedUntil: 0 };
                }
            }
            return { clicks: 0, windowStart: 0, blockedUntil: 0 };
        }

        function setRateLimitData(data) {
            try { localStorage.setItem('clientRateLimit', JSON.stringify(data)); }
            catch (e) { console.error("Error setting rate limit data:", e); }
        }

        // --- Theme Management ---
        const themeToggleButton = document.getElementById('theme-toggle');
        const currentTheme = localStorage.getItem('theme') || 'dark';

        function applyTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                themeToggleButton.textContent = 'تغییر به تم تیره 🌜';
            } else {
                document.body.classList.remove('light-theme');
                themeToggleButton.textContent = 'تغییر به تم روشن 🌞';
            }
        }
        applyTheme(currentTheme);

        if (themeToggleButton) {
            themeToggleButton.addEventListener('click', () => {
                document.body.classList.toggle('light-theme');
                let newTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
        }

        // --- Data for API and Remote Config Options ---
        const apiBackends = [
            { label: "فیلترشکن فایرلایت【vless reality+hy1+hy2】", value: "https://url.v1.mk/sub" },
            { label: "فیلترشکن فایرلایت پشتیبان【vless reality+hy1+hy2】", value: "https://sub.d1.mk/sub" },
            { label: "つつ-چند منطقه‌ای ضد قطع شدن【توازن بار + بهینه‌سازی داخلی】", value: "https://api.tsutsu.one/sub" },
            { label: "ارائه شده توسط nameless13", value: "https://www.nameless13.com/sub" },
            { label: "ارائه شده توسط نویسنده subconverter", value: "https://sub.xeton.dev/sub" },
            { label: "ارائه شده توسط نویسنده sub-web", value: "https://api.wcc.best/sub" },
            { label: "ارائه شده توسط نویسنده sub & lhie1", value: "https://api.dler.io/sub" },
        ];

        const remoteConfigs = [
            {
                label: "عمومی",
                options: [
                    { label: "پیش‌فرض", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full_NoAuto.ini" },
                    { label: "پیش‌فرض (تست خودکار سرعت)", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full_AdblockPlus.ini" },
                    { label: "پیش‌فرض (مخصوص تلویزیون سونی)", value: "https://raw.githubusercontent.com/youshandefeiyang/webcdn/main/SONY.ini" },
                    { label: "پیش‌فرض (همراه با AdGuard DNS برای Clash)", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/default_with_clash_adg.yml" },
                    { label: "ACL_تمام گروه‌ها نسخه اصلاح شده Dream", value: "https://raw.githubusercontent.com/WC-Dream/ACL4SSR/WD/Clash/config/ACL4SSR_Online_Full_Dream.ini" },
                    { label: "ACL_گروه‌های فشرده نسخه اصلاح شده Dream", value: "https://raw.githubusercontent.com/WC-Dream/ACL4SSR/WD/Clash/config/ACL4SSR_Mini_Dream.ini" },
                    { label: "emby-TikTok-گروه‌بندی رسانه‌ای-نسخه تقویت شده ضد تبلیغات", value: "https://raw.githubusercontent.com/justdoiting/ClashRule/main/GeneralClashRule.ini" },
                    { label: "گروه‌بندی عمومی رسانه‌ای", value: "https://raw.githubusercontent.com/cutethotw/ClashRule/main/GeneralClashRule.ini" }
                ]
            },
            {
                label: "قوانین ACL",
                options: [
                    { label: "ACL_نسخه پیش‌فرض", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini" },
                    { label: "ACL_نسخه بدون تست سرعت", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_NoAuto.ini" },
                    { label: "ACL_نسخه حذف تبلیغات", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_AdblockPlus.ini" },
                    { label: "ACL_نسخه چند کشوری", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_MultiCountry.ini" },
                    { label: "ACL_نسخه بدون Reject", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_NoReject.ini" },
                    { label: "ACL_نسخه فشرده بدون تست سرعت", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_NoAuto.ini" },
                    { label: "ACL_نسخه تمام گروه‌ها", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full.ini" },
                    { label: "ACL_تمام گروه‌ها نسخه گوگل", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full_Google.ini" },
                    { label: "ACL_تمام گروه‌ها نسخه چند حالته", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full_MultiMode.ini" },
                    { label: "ACL_تمام گروه‌ها نسخه نتفلیکس", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full_Netflix.ini" },
                    { label: "ACL_نسخه فشرده", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini.ini" },
                    { label: "ACL_نسخه فشرده حذف تبلیغات", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_AdblockPlus.ini" },
                    { label: "ACL_نسخه فشرده Fallback", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_Fallback.ini" },
                    { label: "ACL_نسخه فشرده چند کشوری", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiCountry.ini" },
                    { label: "ACL_نسخه فشرده چند حالته", value: "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini" }
                ]
            },
            {
                label: "قوانین جمع‌آوری شده از سراسرウェブ",
                options: [
                    { label: "قوانین معمولی", value: "https://raw.githubusercontent.com/flyhigherpi/merlinclash_clash_related/master/Rule_config/ZHANG.ini" },
                    { label: "استفاده شخصی Cool", value: "https://raw.githubusercontent.com/xiaoshenxian233/cool/rule/complex.ini" },
                    { label: "PharosPro بدون تست سرعت", value: "https://subweb.s3.fr-par.scw.cloud/RemoteConfig/special/phaors.ini" },
                    { label: "انتقال خودکار خطا بر اساس منطقه", value: "https://raw.githubusercontent.com/flyhigherpi/merlinclash_clash_related/master/Rule_config/ZHANG_Area_Fallback.ini" },
                    { label: "تست خودکار سرعت بر اساس منطقه", value: "https://raw.githubusercontent.com/flyhigherpi/merlinclash_clash_related/master/Rule_config/ZHANG_Area_Urltest.ini" },
                    { label: "بدون تست خودکار سرعت بر اساس منطقه", value: "https://raw.githubusercontent.com/flyhigherpi/merlinclash_clash_related/master/Rule_config/ZHANG_Area_NoAuto.ini" },
                    { label: "OoHHHHHHH", value: "https://raw.githubusercontent.com/OoHHHHHHH/ini/master/config.ini" },
                    { label: "CFW-TAP", value: "https://raw.githubusercontent.com/OoHHHHHHH/ini/master/cfw-tap.ini" },
                    { label: "lhl77 تمام گروه‌ها (به‌روزرسانی منظم)", value: "https://raw.githubusercontent.com/lhl77/sub-ini/main/tsutsu-full.ini" },
                    { label: "lhl77 نسخه ساده (به‌روزرسانی منظم)", value: "https://raw.githubusercontent.com/lhl77/sub-ini/main/tsutsu-mini-gfw.ini" },
                    { label: "قوانین ConnersHua Shenji Outbound", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/connershua_new.ini" },
                    { label: "قوانین ConnersHua Shenji Inbound مخصوص بازگشت به چین", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/connershua_backtocn.ini" },
                    { label: "قوانین lhie1 Dongzhu (با استفاده از قوانین گروه‌بندی Clash)", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/lhie1_clash.ini" },
                    { label: "نسخه کامل قوانین lhie1 Dongzhu", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/lhie1_dler.ini" },
                    { label: "قوانین eHpo1", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/ehpo1_main.ini" },
                    { label: "حالت لیست سفید پیش‌فرض چند استراتژی گروهی", value: "https://raw.nameless13.com/api/public/dl/ROzQqi2S/white.ini" },
                    { label: "چند استراتژی گروهی می‌تواند به طور موثرتری از فعال شدن حسابرسی جلوگیری کند", value: "https://raw.nameless13.com/api/public/dl/ptLeiO3S/mayinggfw.ini" },
                    { label: "لیست سفید پیش‌فرض استراتژی ساده", value: "https://raw.nameless13.com/api/public/dl/FWSh3dXz/easy3.ini" },
                    { label: "افزودن استراتژی SMTP به چند استراتژی", value: "https://raw.nameless13.com/api/public/dl/L_-vxO7I/youtube.ini" },
                    { label: "توصیه برای مبتدیان بدون استراتژی", value: "https://raw.nameless13.com/api/public/dl/zKF9vFbb/easy.ini" },
                    { label: "توصیه برای مبتدیان بدون استراتژی با گروه‌بندی کشور", value: "https://raw.nameless13.com/api/public/dl/E69bzCaE/easy2.ini" },
                    { label: "فقط IPIP CN + Final بدون استراتژی", value: "https://raw.nameless13.com/api/public/dl/XHr0miMg/ipip.ini" },
                    { label: "گروه‌بندی VIP Maying بدون استراتژی", value: "https://raw.nameless13.com/api/public/dl/BBnfb5lD/MAYINGVIP.ini" },
                    { label: "پیکربندی اختصاصی Pinyun (فقط گروه‌بندی منطقه هنگ کنگ)", value: "https://raw.githubusercontent.com/Mazeorz/airports/master/Clash/Examine.ini" },
                    { label: "پیکربندی اختصاصی Pinyun (گروه‌بندی تمام مناطق)", value: "https://raw.githubusercontent.com/Mazeorz/airports/master/Clash/Examine_Full.ini" },
                    { label: "قوانین nzw9314", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/nzw9314_custom.ini" },
                    { label: "قوانین maicoo-l", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/maicoo-l_custom.ini" },
                    { label: "قوانین سفارشی شده DlerCloud Platinum Li Ge", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/dlercloud_lige_platinum.ini" },
                    { label: "قوانین سفارشی شده DlerCloud Gold Li Ge", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/dlercloud_lige_gold.ini" },
                    { label: "قوانین سفارشی شده DlerCloud Silver Li Ge", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/dlercloud_lige_silver.ini" },
                    { label: "استفاده شخصی ProxyStorage", value: "https://unpkg.com/proxy-script/config/Clash/clash.ini" },
                    { label: "قوانین اصلاح شده ShellClash (توسط UlinoyaPed)", value: "https://github.com/UlinoyaPed/ShellClash/raw/master/rules/ShellClash.ini" }
                ]
            },
            {
                label: "قوانین فرودگاه‌های بزرگ",
                options: [
                    { label: "EXFLUX", value: "https://gist.github.com/jklolixxs/16964c46bad1821c70fa97109fd6faa2/raw/EXFLUX.ini" },
                    { label: "NaNoport", value: "https://gist.github.com/jklolixxs/32d4e9a1a5d18a92beccf3be434f7966/raw/NaNoport.ini" },
                    { label: "CordCloud", value: "https://gist.github.com/jklolixxs/dfbe0cf71ffc547557395c772836d9a8/raw/CordCloud.ini" },
                    { label: "BigAirport", value: "https://gist.github.com/jklolixxs/e2b0105c8be6023f3941816509a4c453/raw/BigAirport.ini" },
                    { label: "跑路云", value: "https://gist.github.com/jklolixxs/9f6989137a2cfcc138c6da4bd4e4cbfc/raw/PaoLuCloud.ini" },
                    { label: "WaveCloud", value: "https://gist.github.com/jklolixxs/fccb74b6c0018b3ad7b9ed6d327035b3/raw/WaveCloud.ini" },
                    { label: "几鸡", value: "https://gist.github.com/jklolixxs/bfd5061dceeef85e84401482f5c92e42/raw/JiJi.ini" },
                    { label: "四季加速", value: "https://gist.github.com/jklolixxs/6ff6e7658033e9b535e24ade072cf374/raw/SJ.ini" },
                    { label: "ImmTelecom", value: "https://gist.github.com/jklolixxs/24f4f58bb646ee2c625803eb916fe36d/raw/ImmTelecom.ini" },
                    { label: "AmyTelecom", value: "https://gist.githubusercontent.com/jklolixxs/b53d315cd1cede23af83322c26ce34ec/raw/AmyTelecom.ini" },
                    { label: "LinkCube", value: "https://subweb.s3.fr-par.scw.cloud/RemoteConfig/customized/convenience.ini" },
                    { label: "Miaona", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/Miaona.ini" },
                    { label: "Foo&Friends", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/Foo&Friends.ini" },
                    { label: "ABCloud", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/ABCloud.ini" },
                    { label: "咸鱼", value: "https://raw.githubusercontent.com/SleepyHeeead/subconverter-config/master/remote-config/customized/xianyu.ini" },
                    { label: "便利店", value: "https://subweb.oss-cn-hongkong.aliyuncs.com/RemoteConfig/customized/convenience.ini" },
                    { label: "CNIX", value: "https://raw.githubusercontent.com/Mazeorz/airports/master/Clash/SSRcloud.ini" },
                    { label: "Nirvana", value: "https://raw.githubusercontent.com/Mazetsz/ACL4SSR/master/Clash/config/V2rayPro.ini" },
                    { label: "V2Pro", value: "https://raw.githubusercontent.com/Mazeorz/airports/master/Clash/V2Pro.ini" },
                    { label: "史迪仔-تست خودکار سرعت", value: "https://raw.githubusercontent.com/Mazeorz/airports/master/Clash/Stitch.ini" },
                    { label: "史迪仔-توازن بار", value: "https://raw.githubusercontent.com/Mazeorz/airports/master/Clash/Stitch-Balance.ini" },
                    { label: "Maying", value: "https://raw.githubusercontent.com/SleepyHeeead/subconverter-config/master/remote-config/customized/maying.ini" },
                    { label: "Ytoo", value: "https://subweb.s3.fr-par.scw.cloud/RemoteConfig/customized/ytoo.ini" },
                    { label: "w8ves", value: "https://raw.nameless13.com/api/public/dl/M-We_Fn7/w8ves.ini" },
                    { label: "NyanCAT", value: "https://raw.githubusercontent.com/SleepyHeeead/subconverter-config/master/remote-config/customized/nyancat.ini" },
                    { label: "Nexitally", value: "https://subweb.s3.fr-par.scw.cloud/RemoteConfig/customized/nexitally.ini" },
                    { label: "SoCloud", value: "https://raw.githubusercontent.com/SleepyHeeead/subconverter-config/master/remote-config/customized/socloud.ini" },
                    { label: "ARK", value: "https://raw.githubusercontent.com/SleepyHeeead/subconverter-config/master/remote-config/customized/ark.ini" },
                    { label: "N3RO", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/n3ro_optimized.ini" },
                    { label: "Scholar", value: "https://gist.githubusercontent.com/tindy2013/1fa08640a9088ac8652dbd40c5d2715b/raw/scholar_optimized.ini" },
                    { label: "Flowercloud", value: "https://subweb.s3.fr-par.scw.cloud/RemoteConfig/customized/flower.ini" }
                ]
            },
            {
                label: "ویژه",
                options: [
                    { label: "NeteaseUnblock", value: "https://raw.githubusercontent.com/SleepyHeeead/subconverter-config/master/remote-config/special/netease.ini" },
                    { label: "پایه", value: "https://raw.githubusercontent.com/SleepyHeeead/subconverter-config/master/remote-config/special/basic.ini" }
                ]
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const apiUrlSelect = document.getElementById('api-url-select');
            const apiUrlCustom = document.getElementById('api-url-custom');
            const apiUrlCustomToggle = document.getElementById('api-url-custom-toggle');
            const configSelect = document.getElementById('config-select');
            const configCustom = document.getElementById('config-custom');
            const configCustomToggle = document.getElementById('config-custom-toggle');

            if (apiUrlSelect) {
                apiBackends.forEach(backend => {
                    const option = document.createElement('option');
                    option.value = backend.value;
                    option.textContent = backend.label;
                    apiUrlSelect.appendChild(option);
                });
                apiUrlSelect.value = "https://url.v1.mk/sub";
            }

            if (configSelect) {
                const iranConfigOption = document.createElement('option');
                iranConfigOption.value = "https://raw.githubusercontent.com/10ium/clash_rules/refs/heads/main/ACL4SSR/vpnclashfa.ini";
                iranConfigOption.textContent = "مخصوص ایران";
                configSelect.appendChild(iranConfigOption);

                remoteConfigs.forEach(group => {
                    group.options.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.value;
                        option.textContent = `${group.label} - ${config.label}`;
                        configSelect.appendChild(option);
                    });
                });
                configSelect.value = "https://raw.githubusercontent.com/10ium/clash_rules/refs/heads/main/ACL4SSR/vpnclashfa.ini";
            }

            function setupToggle(selectElement, customInputElement, toggleCheckbox) {
                toggleCheckbox.addEventListener('change', () => {
                    if (toggleCheckbox.checked) {
                        selectElement.classList.add('hidden');
                        customInputElement.classList.remove('hidden');
                        customInputElement.value = '';
                    } else {
                        selectElement.classList.remove('hidden');
                        customInputElement.classList.add('hidden');
                        customInputElement.value = '';
                    }
                });
            }

            if (apiUrlSelect && apiUrlCustom && apiUrlCustomToggle) {
                setupToggle(apiUrlSelect, apiUrlCustom, apiUrlCustomToggle);
            }
            if (configSelect && configCustom && configCustomToggle) {
                setupToggle(configSelect, configCustom, configCustomToggle);
            }

            const toggleAdvancedBtn = document.getElementById('toggle-advanced-btn');
            const advancedFeaturesSection = document.getElementById('advanced-features-section');

            if (toggleAdvancedBtn && advancedFeaturesSection) {
                toggleAdvancedBtn.addEventListener('click', () => {
                    advancedFeaturesSection.classList.toggle('hidden-section');
                });
            }
        });

        const generateBtn = document.getElementById('generate-btn');
        const outputUrlField = document.getElementById('output-url');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn');
        const subUrlInput = document.getElementById('sub-url');
        const outputFilenameInput = document.getElementById('output-filename');
        const emojiCheckbox = document.getElementById('emoji');
        const includeRemarksInput = document.getElementById('include-remarks');
        const excludeRemarksInput = document.getElementById('exclude-remarks');
        const nodeRenameInput = document.getElementById('node-rename');
        const remoteDeviceIdInput = document.getElementById('remote-device-id');
        const nodeListOnlyCheckbox = document.getElementById('node-list-only');

        if (generateBtn) {
            generateBtn.addEventListener('click', async function() {
                let rateData = getRateLimitData();
                const currentTime = Date.now();

                if (rateData.blockedUntil && currentTime < rateData.blockedUntil) {
                    const totalRemainingSeconds = Math.ceil((rateData.blockedUntil - currentTime) / 1000);
                    const remainingHours = Math.floor(totalRemainingSeconds / 3600);
                    const remainingMinutes = Math.ceil((totalRemainingSeconds % 3600) / 60);
                    let timeLeftMessage = "";
                    if (remainingHours > 0) {
                        timeLeftMessage = `حدود ${remainingHours} ساعت`;
                        if (remainingMinutes > 0 && remainingHours < 2 && totalRemainingSeconds < 7200) {
                           timeLeftMessage = `حدود ${Math.floor(totalRemainingSeconds / 60)} دقیقه`;
                        } else if (remainingMinutes > 0) {
                           timeLeftMessage += ` و ${remainingMinutes} دقیقه`;
                        }
                    } else if (remainingMinutes > 0) {
                        timeLeftMessage = `حدود ${remainingMinutes} دقیقه`;
                    } else {
                        timeLeftMessage = "کمتر از یک دقیقه";
                    }
                    showMessage(`شما به دلیل تعداد زیاد درخواست، موقتاً برای ${timeLeftMessage} دیگر نمی‌توانید از این قابلیت استفاده کنید.`, 'error');
                    return;
                }

                if (currentTime - rateData.windowStart > TIME_WINDOW_CLIENT_MS || (rateData.blockedUntil && currentTime > rateData.blockedUntil)) {
                    rateData.clicks = 0; rateData.windowStart = currentTime; rateData.blockedUntil = 0;
                }
                rateData.clicks++;
                console.log(`Client clicks: ${rateData.clicks} in window. Window started: ${new Date(rateData.windowStart).toLocaleTimeString()}`);
                if (rateData.clicks > MAX_CLICKS_CLIENT) {
                    showMessage(`شما بیش از ${MAX_CLICKS_CLIENT} بار در یک ساعت درخواست داده‌اید. لطفاً حدود ۲ ساعت دیگر دوباره امتحان کنید.`, 'error', 5000);
                    rateData.blockedUntil = currentTime + TIMEOUT_DURATION_CLIENT_MS;
                    setRateLimitData(rateData);
                    if(outputUrlField) outputUrlField.value = 'محدودیت استفاده اعمال شد.';
                    return;
                }
                setRateLimitData(rateData);

                const useCustomWorker = document.getElementById('use_custom_base64_worker').checked;
                const subUrl = subUrlInput.value.trim();
                const apiUrlSelect = document.getElementById('api-url-select');
                const apiUrlCustom = document.getElementById('api-url-custom');
                const apiUrlCustomToggle = document.getElementById('api-url-custom-toggle');
                const mainConverterApiUrl = apiUrlCustomToggle.checked ? apiUrlCustom.value.trim() : apiUrlSelect.value;
                const configSelect = document.getElementById('config-select');
                const configCustom = document.getElementById('config-custom');
                const configCustomToggle = document.getElementById('config-custom-toggle');
                const remoteConfigUrl = configCustomToggle.checked ? configCustom.value.trim() : configSelect.value;

                if (!subUrl) { showMessage('لطفاً حداقل یک لینک اشتراک وارد کنید.', 'error'); return; }

                const target = document.getElementById('target').value;
                const filenameValue = outputFilenameInput ? outputFilenameInput.value.trim() : '';
                const emojiEnabled = emojiCheckbox ? emojiCheckbox.checked : true;
                const includeRemarksValue = includeRemarksInput ? includeRemarksInput.value.trim() : '';
                const excludeRemarksValue = excludeRemarksInput ? excludeRemarksInput.value.trim() : '';
                const nodeRenameValue = nodeRenameInput ? nodeRenameInput.value.trim() : '';
                const remoteDeviceIdValue = remoteDeviceIdInput ? remoteDeviceIdInput.value.trim() : '';
                const nodeListOnlyEnabled = nodeListOnlyCheckbox ? nodeListOnlyCheckbox.checked : false;

                const options = {};
                document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(cb => {
                    if (cb.id !== 'use_custom_base64_worker' && cb.id !== 'emoji' && cb.id !== 'node-list-only') {
                        options[cb.id] = cb.checked;
                    }
                });
                options['list'] = nodeListOnlyEnabled;
                options['emoji'] = emojiEnabled;

                if(outputUrlField) outputUrlField.value = 'در حال پردازش...';

                if (useCustomWorker) {
                    const workerUrl = 'https://my-sub-proxy-worker.tenium.workers.dev';
                    try {
                        const response = await fetch(workerUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                subUrl: subUrl,
                                target: target,
                                config: remoteConfigUrl || null,
                                filename: filenameValue || null,
                                include: includeRemarksValue || null,
                                exclude: excludeRemarksValue || null,
                                rename: nodeRenameValue || null,
                                dev_id: remoteDeviceIdValue || null,
                                list: nodeListOnlyEnabled,
                                options: options,
                            })
                        });
                        const responseData = await response.json();
                        if (!response.ok) { throw new Error(responseData.error || `خطا از سرور واسط: ${response.status} ${response.statusText}`); }
                        if(outputUrlField) outputUrlField.value = responseData.finalUrl;
                        showMessage('لینک اشتراک با موفقیت تولید شد!', 'success');
                    } catch (error) {
                        showMessage(`خطا در ارتباط با سرور واسط: ${error.message}`, 'error', 7000);
                        if(outputUrlField) outputUrlField.value = '';
                    }
                } else {
                    if (!mainConverterApiUrl) { showMessage('لطفاً آدرس سرویس مبدل (API) را وارد کنید.', 'error'); if(outputUrlField) outputUrlField.value = ''; return; }
                    const baseUrl = mainConverterApiUrl.endsWith('?') ? mainConverterApiUrl : mainConverterApiUrl + '?';
                    const params = new URLSearchParams();
                    params.append('url', subUrl);
                    params.append('target', target);
                    if (remoteConfigUrl) { params.append('config', remoteConfigUrl); }
                    if (filenameValue) { params.append('filename', filenameValue); }
                    if (includeRemarksValue) { params.append('include', includeRemarksValue); }
                    if (excludeRemarksValue) { params.append('exclude', excludeRemarksValue); }
                    if (nodeRenameValue) { params.append('rename', nodeRenameValue); }
                    if (remoteDeviceIdValue) { params.append('dev_id', remoteDeviceIdValue); }
                    params.append('list', nodeListOnlyEnabled.toString());
                    for (const key in options) {
                        if (options.hasOwnProperty(key)) {
                            params.append(key, options[key]);
                        }
                    }
                    const finalUrl = baseUrl + params.toString();
                    if(outputUrlField) outputUrlField.value = finalUrl;
                    showMessage('لینک اشتراک با موفقیت تولید شد!', 'success');
                }
            });
        } else { console.error("Generate button ('generate-btn') not found!"); }

        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                const currentOutputUrlField = document.getElementById('output-url');
                if (currentOutputUrlField && currentOutputUrlField.value && currentOutputUrlField.value !== 'در حال پردازش...' && currentOutputUrlField.value !== 'محدودیت استفاده اعمال شد.') {
                    currentOutputUrlField.select();
                    currentOutputUrlField.setSelectionRange(0, 99999);
                    try {
                        document.execCommand('copy');
                        showMessage('لینک با موفقیت کپی شد!', 'success');
                    } catch (err) {
                        showMessage('مرورگر شما از کپی خودکار پشتیبانی نمی‌کند. لطفاً دستی کپی کنید.', 'error');
                    }
                } else if (currentOutputUrlField && (currentOutputUrlField.value === 'در حال پردازش...' || currentOutputUrlField.value === 'محدودیت استفاده اعمال شد.')) {
                    showMessage('لطفاً تا پایان عملیات یا رفع محدودیت صبر کنید.', 'info');
                } else { showMessage('هنوز لینکی تولید نشده است.', 'info'); }
            });
        } else { console.error("Copy button ('copy-btn') not found!"); }

        if (downloadBtn) {
            downloadBtn.addEventListener('click', async function() {
                const currentOutputUrlField = document.getElementById('output-url');
                const outputUrl = currentOutputUrlField ? currentOutputUrlField.value : '';

                if (!outputUrl || outputUrl === 'در حال پردازش...' || outputUrl === 'محدودیت استفاده اعمال شد.') {
                    showMessage('ابتدا یک لینک معتبر تولید کنید تا بتوانید محتوای آن را دانلود کنید.', 'info');
                    return;
                }

                let filename = outputFilenameInput && outputFilenameInput.value.trim() !== '' ? outputFilenameInput.value.trim() : "subscription.txt";
                const targetSelect = document.getElementById('target');
                if (targetSelect) {
                    const targetValue = targetSelect.value;
                    if (targetValue.includes('clash')) {
                        if (!filename.endsWith('.yaml') && !filename.endsWith('.yml')) {
                            filename = filename.split('.')[0] + '.yaml';
                        }
                    }
                    else if (targetValue.includes('v2ray')) {
                        if (!filename.endsWith('.txt')) {
                            filename = filename.split('.')[0] + '.txt';
                        }
                    }
                }

                const originalButtonText = downloadBtn.textContent;
                downloadBtn.textContent = 'در حال دانلود...';
                downloadBtn.disabled = true;

                try {
                    console.log(`Attempting to download content from: ${outputUrl}`);
                    const response = await fetch(outputUrl);
                    if (!response.ok) {
                        throw new Error(`خطا در دریافت محتوای لینک: ${response.status} ${response.statusText}`);
                    }
                    const content = await response.text();
                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    showMessage(`دانلود فایل '${filename}' شروع شد.`, 'success');
                } catch (error) {
                    console.error('Download error:', error);
                    showMessage(`خطا در دانلود فایل: ${error.message}\n\nاین مشکل ممکن است به دلیل محدودیت‌های CORS از سمت سرور لینک تولید شده باشد. اگر از گزینه "تبدیل به بیس ۶۴" استفاده نکرده‌اید، این قابلیت ممکن است کار نکند. در این صورت، لینک را کپی کرده و مستقیماً در مرورگر باز کنید و محتوا را ذخیره نمایید.`, 'error', 10000);
                } finally {
                    downloadBtn.textContent = originalButtonText;
                    downloadBtn.disabled = false;
                }
            });
        } else {
            console.error("Download button ('download-btn') not found!");
        }
    </script>
</body>
</html>